<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 2010 Hippo
  
  Licensed under the Apache License, Version 2.0 (the  "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
  http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS"
  BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!--
  This file is based on ECM's 
  /repository/application/src/main/resources/org/hippoecm/repository/repository.xml
  so please keep in sync when upgrading to a newer ECM version
-->

<!DOCTYPE Repository PUBLIC "-//The Apache Software Foundation//DTD Jackrabbit 1.5//EN"
    "http://jackrabbit.apache.org/dtd/repository-1.5.dtd">
<Repository>
  
  
  <FileSystem class="org.apache.jackrabbit.core.fs.db.DbFileSystem">
    <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
    <param name="driver" value="com.mysql.jdbc.Driver"/>
    <param name="user" value="USERNAME"/>
    <param name="password" value="PASSWORD"/>
    <param name="schemaObjectPrefix" value="repository_"/>
    <param name="schema" value="mysql"/>
  </FileSystem>
  
  <!--
    security configuration
  -->
  <Security appName="Jackrabbit">
    <SecurityManager class="org.hippoecm.repository.security.SecurityManager"/>
    <AccessManager class="org.hippoecm.repository.security.HippoAccessManager"/>
    <LoginModule class="org.hippoecm.repository.security.HippoLoginModule">
      <param name="maintenanceMode" value="true"/>
    </LoginModule>
  </Security>
  
  
  <!--
    location of workspaces root directory and name of default workspace
  -->
  <Workspaces rootPath="${rep.home}/workspaces" defaultWorkspace="default"/>
 
  <!--
    workspace configuration template:
    used to create the initial workspace if there's no workspace yet
  -->
  <Workspace name="${wsp.name}">
    <FileSystem class="org.apache.jackrabbit.core.fs.db.DbFileSystem">
      <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
      <param name="driver" value="com.mysql.jdbc.Driver"/>
      <param name="user" value="USERNAME"/>
      <param name="password" value="PASSWORD"/>
      <param name="schemaObjectPrefix" value="${wsp.name}_"/>
      <param name="schema" value="mysql"/>
    </FileSystem>
    
    <PersistenceManager class="org.hippoecm.repository.jackrabbit.persistence.ForkedMySqlPersistenceManager">
      <param name="driver" value="com.mysql.jdbc.Driver"/>
      <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
      <param name="user" value="USERNAME"/>
      <param name="password" value="PASSWORD"/>
      <param name="schemaObjectPrefix" value="${wsp.name}_"/>
      <param name="externalBLOBs" value="true"/>
      <param name="consistencyCheck" value="false"/>
      <param name="consistencyFix" value="false"/>
      <param name="bundleCacheSize" value="128"/>
    </PersistenceManager>
    
    <SearchIndex class="org.hippoecm.repository.FacetedNavigationEngineThirdImpl">
      <!--
        Search index and the file system it uses.
        class: FQN of class implementing the QueryHandler interface
        
        If required by the QueryHandler implementation, one may configure
        a FileSystem that the handler may use.
        
        Supported parameters for lucene search index:
        - path: location of the index. This parameter is mandatory!
        - useCompoundFile: advises lucene to use compound files for the index files
        - minMergeDocs: minimum number of nodes in an index until segments are merged
        - volatileIdleTime: idle time in seconds until the volatile index is
        moved to persistent index even though minMergeDocs is not reached.
        - maxMergeDocs: maximum number of nodes in segments that will be merged
        - mergeFactor: determines how often segment indices are merged
        - maxFieldLength: the number of words that are fulltext indexed at most per property.
        - bufferSize: maximum number of documents that are held in a pending
        queue until added to the index
        - cacheSize: size of the document number cache. This cache maps
        uuids to lucene document numbers
        - forceConsistencyCheck: runs a consistency check on every startup. If
        false, a consistency check is only performed when the search index
        detects a prior forced shutdown. This parameter only has an effect
        if 'enableConsistencyCheck' is set to 'true'.
        - enableConsistencyCheck: if set to 'true' a consistency check is
        performed depending on the parameter 'forceConsistencyCheck'. If
        set to 'false' no consistency check is performed on startup, even
        if a redo log had been applied.
        - autoRepair: errors detected by a consistency check are automatically
        repaired. If false, errors are only written to the log.
        - analyzer: class name of a lucene analyzer to use for fulltext indexing of text.
        - queryClass: class name that implements the javax.jcr.query.Query interface.
        this class must extend the class: org.apache.jackrabbit.core.query.AbstractQueryImpl
        - respectDocumentOrder: If true and the query does not contain an 'order by' clause,
        result nodes will be in document order. For better performance when queries return
        a lot of nodes set to 'false'.
        - resultFetchSize: The number of results the query handler should
        initially fetch when a query is executed.
        Default value: Integer.MAX_VALUE (-> all)
        - extractorPoolSize: defines the maximum number of background threads that are
        used to extract text from binary properties. If set to zero (default) no
        background threads are allocated and text extractors run in the current thread.
        - extractorTimeout: a text extractor is executed using a background thread if it
        doesn't finish within this timeout defined in milliseconds. This parameter has
        no effect if extractorPoolSize is zero.
        - extractorBackLogSize: the size of the extractor pool back log. If all threads in
        the pool are busy, incomming work is put into a wait queue. If the wait queue
        reaches the back log size incomming extractor work will not be queued anymore
        but will be executed with the current thread.
        - synonymProviderClass: the name of a class that implements
        org.apache.jackrabbit.core.query.lucene.SynonymProvider. The
        default value is null (-> not set).
        
        Note: all parameters (except path) in this SearchIndex config are default
        values and can be omitted.
      -->
      <param name="indexingConfiguration" value="indexing_configuration.xml"/>
      <param name="indexingConfigurationClass" value="org.hippoecm.repository.query.lucene.ServicingIndexingConfigurationImpl"/>
      <param name="path" value="${wsp.home}/index"/>
      <param name="useCompoundFile" value="true"/>
      <param name="minMergeDocs" value="1000"/>
      <param name="volatileIdleTime" value="10"/>
      <param name="maxMergeDocs" value="1000000000"/>
      <param name="mergeFactor" value="5"/>
      <param name="maxFieldLength" value="10000"/>
      <param name="bufferSize" value="1000"/>
      <param name="cacheSize" value="1000"/>
      <param name="forceConsistencyCheck" value="false"/>
      <param name="enableConsistencyCheck" value="false"/>
      <param name="autoRepair" value="true"/>
      <param name="analyzer" value="org.apache.lucene.analysis.standard.StandardAnalyzer"/>
      <param name="queryClass" value="org.apache.jackrabbit.core.query.QueryImpl"/>
      <param name="respectDocumentOrder" value="false"/>
      <param name="resultFetchSize" value="2147483647"/>
      <param name="extractorPoolSize" value="0"/>
      <param name="extractorTimeout" value="100"/>
      <param name="extractorBackLogSize" value="100"/>
      <param name="textFilterClasses" value="org.apache.jackrabbit.extractor.PlainTextExtractor,org.apache.jackrabbit.extractor.HTMLTextExtractor,org.apache.jackrabbit.extractor.XMLTextExtractor"/>
      <param name="excerptProviderClass" value="org.apache.jackrabbit.core.query.lucene.DefaultHTMLExcerpt"/>
      <param name="supportHighlighting" value="true"/>
    </SearchIndex>
    
    <ISMLocking class="org.apache.jackrabbit.core.state.FineGrainedISMLocking"/>
  </Workspace>
  
  <Versioning rootPath="${rep.home}/version">
    <FileSystem class="org.apache.jackrabbit.core.fs.db.DbFileSystem">
      <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
      <param name="driver" value="com.mysql.jdbc.Driver"/>
      <param name="user" value="USERNAME"/>
      <param name="password" value="PASSWORD"/>
      <param name="schemaObjectPrefix" value="version_"/>
      <param name="schema" value="mysql"/>
    </FileSystem>
    
    <PersistenceManager class="org.hippoecm.repository.jackrabbit.persistence.ForkedMySqlPersistenceManager">
      <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
      <param name="driver" value="com.mysql.jdbc.Driver"/>
      <param name="user" value="USERNAME"/>
      <param name="password" value="PASSWORD"/>
      <param name="schemaObjectPrefix" value="version_"/>
      <param name="externalBLOBs" value="true"/>
      <param name="consistencyCheck" value="false"/>
      <param name="consistencyFix" value="false"/>
    </PersistenceManager>
    <ISMLocking class="org.apache.jackrabbit.core.state.FineGrainedISMLocking"/>
  </Versioning>
  
  
  <!--
    Search index for content that is shared repository wide
    (/jcr:system tree, contains mainly versions)
    
    The same parameters are supported as in the search index configuration
    inside the workspace definition element.
    
    This element is optional. If omitted, the /jcr:system tree will not be
    indexed and no results will be returned for that tree!
  -->
  <SearchIndex class="org.apache.jackrabbit.core.query.lucene.SearchIndex">
    <param name="path" value="${rep.home}/repository/index"/>
    <param name="forceConsistencyCheck" value="false"/>
    <param name="enableConsistencyCheck" value="false"/>
  </SearchIndex>

  <DataStore class="org.apache.jackrabbit.core.data.db.DbDataStore">
      <param name="url" value="jdbc:mysql://HOSTNAME:3306/DATABASE?user=USERNAME&amp;password=PASSWORD&amp;characterEncoding=UTF-8&amp;autoReconnect=true"/>
    <param name="driver" value="com.mysql.jdbc.Driver"/>
    <param name="user" value="USERNAME"/>
    <param name="password" value="PASSWORD"/>
    <param name="databaseType" value="mysql"/>
    <param name="minRecordLength" value="1024"/>
    <param name="maxConnections" value="5"/>
    <param name="copyWhenReading" value="true"/>
    <!-- broken in JR.. param name="tablePrefix" value="repository_"/ -->
  </DataStore>
</Repository>
